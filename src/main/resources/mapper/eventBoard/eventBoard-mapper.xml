<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="eventMapper">

<!-- 		<select id="selectList" parameterType="map" resultType="board">
		SELECT
			BOARD_NO,
			BOARD_TITLE,
			USER_NAME AS BOARD_WRITER,
			COUNT,
			CREATE_DATE
		FROM BOARD B
		LEFT JOIN MEMBER M ON BOARD_WRITER = USER_NO
		WHERE
		B.STATUS='Y' AND BOARD_CD = #{boardCode} -->

<!-- 이거 검색할 때 써야 함===================================================== -->
<!-- 		<if test="keyword != null and keyword != ''">
			AND
			<choose>
				<when test="condition.equals('title')">
					BOARD_TITLE LIKE '%' || #{keyword} || '%'
				</when>
			</choose>
		</if>
	</select> -->
	
	<!-- <select id="selectEventList" parameterType="map" resultType="EventBoard"> -->
	
<!-- 	<select id="selectEventList" parameterType="map" resultType="EventBoard"> -->
	<select id="selectEventList" resultMap="eventBoardMap" parameterType="map">
		SELECT * FROM (
		    SELECT ROWNUM RNUM, N.* FROM (
		    	SELECT
		            APP_ID, 
		            APP_TITLE, 
		            APP_SUB_TITLE,
		            EVENT_CODE,
		            EVENT_NAME,
		            STAT_CODE,
		            LOCATION,
		            START_DATE, 
		            END_DATE,
		            APP_ORG
		        FROM EVENT_APPLICATION
		        JOIN EVENT_CATEGORY USING(EVENT_CODE)
		        WHERE STAT_CODE = 'A'
		        	AND (APP_TITLE LIKE '%' || #{keyword} || '%')
		        	<if test="region != null and region != ''">
						AND
						<choose>
							<when test="region.equals('seoul')">
								LOCATION LIKE '서울' || '%'
							</when>
							<when test="region.equals('gyeonggi')">
								LOCATION LIKE '경기' || '%'
							</when>
							<when test="region.equals('incheon')">
								LOCATION LIKE '인천' || '%'
							</when>
							<when test="region.equals('gangwon')">
								LOCATION LIKE '강원' || '%'
							</when>
							<when test="region.equals('chungcheong')">
								LOCATION LIKE '충북' || '%' OR REGION LIKE '충남' || '%'
							</when>
							<when test="region.equals('jeonla')">
								LOCATION LIKE '경북' || '%' OR REGION LIKE '경남' || '%'
							</when>
							<when test="region.equals('gyeongsang')">
								LOCATION LIKE '전북' || '%' OR REGION LIKE '전남' || '%'
							</when>
							<when test="region.equals('jeju')">
								LOCATION LIKE '제주' || '%'
							</when>
						</choose>
					</if>
					<if test="eventCodeList != null and eventCodeList.size() > 0">
						  AND EVENT_CODE IN
						  <foreach collection="eventCodeList" item="code" separator="," open="(" close=")">
						    #{code}
						  </foreach>
					</if>
					<if test="startDate != null and startDate != ''">
					  	AND END_DATE &gt;= TO_DATE(#{startDate}, 'YY-MM-DD')
					</if>
					<if test="endDate != null and endDate != ''">
					  	AND START_DATE &lt;= TO_DATE(#{endDate}, 'YY-MM-DD')
					</if>
					
		        ORDER BY APP_ID DESC
		    ) N
		    WHERE ROWNUM &lt;= #{endRow}
       	)
      	 WHERE RNUM &gt; #{startRow}
	</select>
	<!-- 시간 되면 위 검색 조건 최적화... 현재 비효율적 -->
	
		        <!-- JOIN EVENT_CATEGORY USING(EVENT_CODE)
		        WHERE STAT_CODE = 'A' 로그인 회원가입 추가 후 수정========================== 
		        
		         AND APP_TITLE LIKE '%' || #{keyword} || '%'
		        
				<if test="keyword != null and keyword != ''">
					AND APP_TITLE LIKE '%' || #{keyword} || '%'
				</if>
		        
				<if test="region != null and region != ''">
					AND BOARD_TITLE LIKE '%' || #{keyword} || '%'
				</if>
		        
		        -->

	<resultMap id="eventBoardMap" type="EventBoard">
        <id property="appId" column="APP_ID"/>
        <result property="appTitle" column="APP_TITLE"/>
        <result property="appSubTitle" column="APP_SUB_TITLE"/>
        <result property="eventCode" column="EVENT_CODE"/>
        <result property="eventName" column="EVENT_NAME"/>
        <result property="statCode" column="STAT_CODE"/>
        <result property="region" column="REGION"/>
        <result property="location" column="LOCATION"/>
        <result property="startDate" column="START_DATE"/>
        <result property="endDate" column="END_DATE"/>
        <result property="appOrg" column="APP_ORG"/>
    </resultMap>
        <!-- appSubTitle 아래 행 <result property="userNo" column="USER_NO"/> --> <!-- 로그인 후========================= -->

	<select id="selectEventCount" resultType="int"> 
			SELECT COUNT(*) 
			FROM (
		    	SELECT
		            APP_ID, 
		            APP_TITLE, 
		            APP_SUB_TITLE,
		            EVENT_CODE,
		            EVENT_NAME,
		            STAT_CODE,
		            LOCATION,
		            START_DATE, 
		            END_DATE,
		            APP_ORG
		        FROM EVENT_APPLICATION
		        JOIN EVENT_CATEGORY USING(EVENT_CODE)
		        WHERE STAT_CODE = 'A'
		        	AND (APP_TITLE LIKE '%' || #{keyword} || '%')
		        	<if test="region != null and region != ''">
						AND
						<choose>
							<when test="region.equals('seoul')">
								LOCATION LIKE '서울' || '%'
							</when>
							<when test="region.equals('gyeonggi')">
								LOCATION LIKE '경기' || '%'
							</when>
							<when test="region.equals('incheon')">
								LOCATION LIKE '인천' || '%'
							</when>
							<when test="region.equals('gangwon')">
								LOCATION LIKE '강원' || '%'
							</when>
							<when test="region.equals('chungcheong')">
								LOCATION LIKE '충북' || '%' OR REGION LIKE '충남' || '%'
							</when>
							<when test="region.equals('jeonla')">
								LOCATION LIKE '경북' || '%' OR REGION LIKE '경남' || '%'
							</when>
							<when test="region.equals('gyeongsang')">
								LOCATION LIKE '전북' || '%' OR REGION LIKE '전남' || '%'
							</when>
							<when test="region.equals('jeju')">
								LOCATION LIKE '제주' || '%'
							</when>
						</choose>
					</if>
		    )
	</select>
	<!--  임시 코드
	SELECT COUNT(*) 
			FROM EVENT_APPLICATION
			WHERE STAT_CODE = 'A'
	 -->
	

	<!-- 
		
		 상세 조회 
		 
		 <select id="selectNoticeById" parameterType="int" resultType="com.kh.festait.noticeboard.model.vo.NoticeBoard"> 
		SELECT NOTICE_ID, NOTICE_TITLE, NOTICE_DETAIL, CREATE_DATE, UPDATE_DATE, HIGHLIGHT
		FROM NOTICE 
		WHERE NOTICE_ID = #{noticeId} 
		</select> -->

</mapper>
